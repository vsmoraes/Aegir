<!DOCTYPE HTML>
<html>
    <head>
        <title>Aegir : Socket client</title>
        <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet">

        <script src="//code.jquery.com/jquery-2.1.1.min.js"></script>
        <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>

        <script type="text/javascript">
            var Class = function(methods) {   
                var klass = function() {    
                    this.initialize.apply(this, arguments);          
                };  
                
                for (var property in methods) { 
                   klass.prototype[property] = methods[property];
                }
                      
                if (!klass.prototype.initialize) klass.prototype.initialize = function(){};      
                
                return klass;    
            };

            var Client = Class({ 
                socket: null,

                host: null,
                port: null,

                initialize: function(host, port) {
                    this.host = host;
                    this.port = port;
                },

                connect: function() {
                    this.socket = new WebSocket('ws://' + this.host + ':' + this.port);
                    this.socket.onopen = this.onOpen;
                    this.socket.onmessage = this.onMessage;
                    this.socket.onerror = this.onError;
                    this.socket.onclose = this.onClose;
                },

                send: function(message) {
                    console.log('@send');

                    this.socket.send(JSON.stringify({
                        event: 'message',
                        message: message
                    }));
                },

                chat: function(message) {
                    $('#chatlog').append('<p>' + message + '</p>');
                },

                onOpen: function(event) {
                    console.log('@onopen');
                },

                onMessage: function(event) {
                    console.log('@onmessage');
                    var data = JSON.parse(event.data);
                    console.log(event);

                    chat.chat(data.message); // @FIX
                },
    
                onError: function(event) { 
                    console.log('@onerror');
                },

                onClose: function(event) { 
                    console.log('@onclose');
                }
            });

            chat = null;
            $(function() {
                $('#send-message').click(function() {
                    var val = $('input[name="message"]').val();
                    var data = {
                        event: 'message',
                        message: val
                    }

                    chat.send(JSON.stringify(data));
                });

                chat = new Client('vsmoraes.dev', 10000);
                chat.connect();
            });
        </script>

        <style text="text/css">
            .starter-template {
                padding: 40px 15px;
                text-align: center;
            }

            .chat {
                height: 300px;
                text-align: left;
            }
        </style>
    </head>

    <body>
        <div class="container">
            <div class="starter-template">
                <h1>Aegir : PHP Simple Socket Chat</h1>
                
                <div class="well chat" id="chatlog"></div>

                <div class="input-group">
                    <input type="text" name="message" placeholder="Your message here" class="form-control">
                    <span class="input-group-btn">
                        <button class="btn btn-primary" type="button" id="send-message">Send</button>
                    </span>
                </div>
            </div>
        </div>
    </body>
</html>